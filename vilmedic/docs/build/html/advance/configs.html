<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Configuration files &mdash; ViLMedic latest documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Models" href="models.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> ViLMedic
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">ViLMedic</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../vilmedic/installation.html">Installation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Solutions</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../vilmedic/solutions/rrg.html">Radiology Report Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vilmedic/solutions/rrs.html">Radiology Report Summarization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vilmedic/solutions/mvqa.html">Medical VQA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vilmedic/solutions/selfsup.html">Self-supervision</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Model Zoo</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../vilmedic/model_zoo/overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vilmedic/model_zoo/rrg.html">Radiology Report Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vilmedic/model_zoo/rrs.html">Radiology Report Summarization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vilmedic/model_zoo/mvqa.html">Medical VQA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vilmedic/model_zoo/selfsup.html">Self-supervision</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Advanced Topics</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="models.html">Models</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Configs</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#name-and-exp-br">Name and exp <br/></a></li>
<li class="toctree-l2"><a class="reference internal" href="#dataset-br">Dataset <br/></a></li>
<li class="toctree-l2"><a class="reference internal" href="#model-br">Model <br/></a></li>
<li class="toctree-l2"><a class="reference internal" href="#trainor-br">Trainor <br/></a></li>
<li class="toctree-l2"><a class="reference internal" href="#validator-br">Validator <br/></a></li>
<li class="toctree-l2"><a class="reference internal" href="#ensemblor-br">Ensemblor <br/></a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">ViLMedic</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Configuration files</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/advance/configs.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section class="tex2jax_ignore mathjax_ignore" id="configuration-files">
<h1>Configuration files<a class="headerlink" href="#configuration-files" title="Permalink to this headline"></a></h1>
<p>The minimal configuration file looks like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">name</span><span class="p">:</span> <span class="n">my_experiment</span>
<span class="n">ckpt_dir</span><span class="p">:</span> <span class="n">ckpt</span>
<span class="n">dataset</span><span class="p">:</span>
  <span class="n">proto</span><span class="p">:</span> <span class="n">my_dataset</span>
<span class="n">model</span><span class="p">:</span>
  <span class="n">proto</span><span class="p">:</span> <span class="n">my_model</span>
<span class="n">trainor</span><span class="p">:</span>
  <span class="n">optimizer</span><span class="p">:</span> <span class="n">RAdam</span>
  <span class="n">batch_size</span><span class="p">:</span> <span class="mi">64</span>
<span class="n">validator</span><span class="p">:</span>
  <span class="n">batch_size</span><span class="p">:</span> <span class="mi">16</span>
  <span class="n">metrics</span><span class="p">:</span> <span class="p">[</span><span class="n">accuracy</span><span class="p">]</span>
  <span class="n">splits</span><span class="p">:</span> <span class="p">[</span><span class="n">validate</span><span class="p">]</span>
<span class="n">ensemblor</span><span class="p">:</span>
  <span class="n">batch_size</span><span class="p">:</span> <span class="mi">16</span>
  <span class="n">metrics</span><span class="p">:</span> <span class="p">[</span><span class="n">accuracy</span><span class="p">,</span> <span class="n">f1</span><span class="o">-</span><span class="n">score</span><span class="p">,</span> <span class="n">auroc</span><span class="p">]</span>
  <span class="n">splits</span><span class="p">:</span> <span class="p">[</span><span class="n">validate</span><span class="p">,</span> <span class="n">test</span><span class="p">]</span>
</pre></div>
</div>
<section id="name-and-exp-br">
<h2>Name and exp <br/><a class="headerlink" href="#name-and-exp-br" title="Permalink to this headline"></a></h2>
<hr/>
<p>All output files (logs, checkpoints,… ) will be stored in <code class="docutils literal notranslate"><span class="pre">ckpt/my_exp</span></code>.</p>
<br/>
</section>
<section id="dataset-br">
<h2>Dataset <br/><a class="headerlink" href="#dataset-br" title="Permalink to this headline"></a></h2>
<hr/>
<p><code class="docutils literal notranslate"><span class="pre">proto</span></code> contains the dataset classname existing in the <a class="reference external" href="https://github.com/jbdel/vilmedic/blob/main/vilmedic/datasets/__init__.py">dataset folder</a>.
<br/></p>
<p>You can pass arguments to the <code class="docutils literal notranslate"><span class="pre">my_dataset</span></code> class as such:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dataset</span><span class="p">:</span>
  <span class="n">proto</span><span class="p">:</span> <span class="n">my_dataset</span>
  <span class="n">image</span><span class="p">:</span>
    <span class="n">root</span><span class="p">:</span> <span class="n">data</span><span class="o">/</span><span class="n">rrg</span><span class="o">/</span><span class="n">mimic</span><span class="o">-</span><span class="n">cxr</span><span class="o">/</span>
    <span class="n">file</span><span class="p">:</span> <span class="n">image</span><span class="o">.</span><span class="n">tok</span>
    <span class="n">image_path</span><span class="p">:</span> <span class="n">data</span><span class="o">/</span><span class="n">report_sum</span><span class="o">/</span>
    <span class="n">load_memory</span><span class="p">:</span> <span class="kc">False</span>
    <span class="n">ext</span><span class="p">:</span> <span class="o">.</span><span class="n">jpg</span>
</pre></div>
</div>
<p>And catch it in the dataset as such:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">my_dataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_path</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="s2">&quot;image_path&quot;</span><span class="p">]</span>    
</pre></div>
</div>
<br/>
</section>
<section id="model-br">
<h2>Model <br/><a class="headerlink" href="#model-br" title="Permalink to this headline"></a></h2>
<hr/>
<p><code class="docutils literal notranslate"><span class="pre">proto</span></code> contains the model classname existing in the <a class="reference external" href="https://github.com/jbdel/vilmedic/blob/main/vilmedic/models/__init__.py">model folder</a>.
<br/>
You can pass blocks to the <code class="docutils literal notranslate"><span class="pre">my_model</span></code> class as such:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="p">:</span>
  <span class="n">proto</span><span class="p">:</span> <span class="n">my_model</span>
  <span class="n">cnn</span><span class="p">:</span>
    <span class="n">proto</span><span class="p">:</span> <span class="n">CNN</span>
    <span class="n">backbone</span><span class="p">:</span> <span class="n">densenet169</span>
    <span class="n">output_layer</span><span class="p">:</span> <span class="n">features</span>

  <span class="n">transformer</span><span class="p">:</span>
    <span class="n">proto</span><span class="p">:</span> <span class="n">HFDecoder</span>
    <span class="n">hidden_size</span><span class="p">:</span> <span class="mi">768</span>
    <span class="n">intermediate_size</span><span class="p">:</span> <span class="mi">2048</span>
    <span class="n">num_hidden_layers</span><span class="p">:</span> <span class="mi">12</span>
</pre></div>
</div>
<p>And catch it in the model as such:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">my_model</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnn</span><span class="p">,</span> <span class="n">transformer</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="c1"># Encoder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cnn</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">cnn</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;proto&#39;</span><span class="p">))(</span><span class="o">**</span><span class="n">cnn</span><span class="p">)</span>
        <span class="c1"># Decoder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dec</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">cnn</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;transformer&#39;</span><span class="p">))(</span><span class="o">**</span><span class="n">transformer</span><span class="p">)</span>
    
    <span class="c1"># Build you solution base on these bocks.</span>
</pre></div>
</div>
<br/>
</section>
<section id="trainor-br">
<h2>Trainor <br/><a class="headerlink" href="#trainor-br" title="Permalink to this headline"></a></h2>
<hr/>
<p>Defines the training loop. Here are options available</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">trainor</span><span class="p">:</span>
  <span class="n">batch_size</span><span class="p">:</span> <span class="mi">64</span>
  <span class="n">optimizer</span><span class="p">:</span> <span class="n">RAdam</span>
  <span class="n">optim_params</span><span class="p">:</span> <span class="p">{</span><span class="n">lr</span><span class="p">:</span> <span class="mf">0.0005</span><span class="p">,</span> <span class="n">weight_decay</span><span class="p">:</span> <span class="mf">0.00001</span><span class="p">}</span>
  <span class="n">lr_decay_factor</span><span class="p">:</span> <span class="mf">0.5</span>
  <span class="n">lr_decay_patience</span><span class="p">:</span> <span class="mi">1</span>
  <span class="n">lr_min</span><span class="p">:</span> <span class="mf">0.000001</span>
  <span class="n">epochs</span><span class="p">:</span> <span class="mi">99</span>
  <span class="n">eval_start</span><span class="p">:</span> <span class="mi">0</span>
  <span class="n">early_stop</span><span class="p">:</span> <span class="mi">10</span>
  <span class="n">early_stop_metric</span><span class="p">:</span> <span class="n">BLEU</span>
</pre></div>
</div>
<ul class="simple">
<li><p>optimizer: can be a class from <a class="reference external" href="https://pytorch.org/docs/stable/optim.html">torch.optim</a> or <a class="reference external" href="https://github.com/jettify/pytorch-optimizer">pytorch_optimizer</a>.
<code class="docutils literal notranslate"><span class="pre">optim_params</span></code> are passed to the optimizer class.</p></li>
<li><p>early_stop: defines how many evaluation should be carried out without improvement on <code class="docutils literal notranslate"><span class="pre">early_stop_metric</span></code> metric before stopping training</p></li>
</ul>
<br/>
</section>
<section id="validator-br">
<h2>Validator <br/><a class="headerlink" href="#validator-br" title="Permalink to this headline"></a></h2>
<hr/>
<p>Defines the validation loop. Here are options available:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">validator</span><span class="p">:</span>
  <span class="n">batch_size</span><span class="p">:</span> <span class="mi">16</span>
  <span class="n">beam_width</span><span class="p">:</span> <span class="mi">8</span>
  <span class="n">metrics</span><span class="p">:</span> <span class="p">[</span><span class="n">ROUGE2</span><span class="p">,</span> <span class="n">BLEU</span><span class="p">,</span> <span class="n">METEOR</span><span class="p">]</span>
  <span class="n">splits</span><span class="p">:</span> <span class="p">[</span><span class="n">validate</span><span class="p">]</span>
</pre></div>
</div>
<ul class="simple">
<li><p>beam_width: can be specified for language generation tasks</p></li>
<li><p>metrics: used during evaluation</p></li>
<li><p>splits: specifies the filename pattern used by the Dataset class during evaluation (i.e. dataloader will get all the
validate* files in specified data folder, more infos in the dataset section). If multiple splits are defined, the evaluator
will return metrics for each split and the Trainor will use the averaged <code class="docutils literal notranslate"><span class="pre">early_stop_metric</span></code> across the splits.</p></li>
</ul>
<br/>
</section>
<section id="ensemblor-br">
<h2>Ensemblor <br/><a class="headerlink" href="#ensemblor-br" title="Permalink to this headline"></a></h2>
<hr/>
<p>Defines the ensemble script. Here are options available:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ensemblor</span><span class="p">:</span>
  <span class="n">batch_size</span><span class="p">:</span> <span class="mi">16</span>
  <span class="n">beam_width</span><span class="p">:</span> <span class="mi">8</span>
  <span class="n">metrics</span><span class="p">:</span> <span class="p">[</span><span class="n">ROUGE2</span><span class="p">,</span> <span class="n">BLEU</span><span class="p">,</span> <span class="n">METEOR</span><span class="p">]</span>
  <span class="n">splits</span><span class="p">:</span> <span class="p">[</span><span class="n">validate</span><span class="p">,</span> <span class="n">test</span><span class="p">]</span>
  <span class="n">mode</span><span class="p">:</span> <span class="nb">all</span>
</pre></div>
</div>
<ul class="simple">
<li><p>beam_width: can be specified for language generation tasks</p></li>
<li><p>mode: specifies how many checkpoint should be ensemble. If <code class="docutils literal notranslate"><span class="pre">all</span></code>, the Ensemblor considers all checkpoints in <code class="docutils literal notranslate"><span class="pre">ckpt/my_exp</span></code>. If <code class="docutils literal notranslate"><span class="pre">best-n</span></code>,
the Ensemblor takes the <code class="docutils literal notranslate"><span class="pre">n</span></code> best checkpoints according to <code class="docutils literal notranslate"><span class="pre">early_stop_metric</span></code>. If mode is a path, i.e. <code class="docutils literal notranslate"><span class="pre">ckpt/my_exp/50.36_10_0.ckpt</span></code>, only evaluate this checkpoint.</p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="models.html" class="btn btn-neutral float-left" title="Models" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Jean-Benoit Delbrouck.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>